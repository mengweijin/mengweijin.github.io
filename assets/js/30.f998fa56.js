(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{443:function(s,a,n){"use strict";n.r(a);var t=n(28),e=Object(t.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("官方文档："),n("a",{attrs:{href:"https://eco.dameng.com/document/dm/zh-cn/ops/physical-backup-restore.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://eco.dameng.com/document/dm/zh-cn/ops/physical-backup-restore.html"),n("OutboundLink")],1)]),s._v(" "),n("h3",{attrs:{id:"阅读说明"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#阅读说明"}},[s._v("#")]),s._v(" 阅读说明")]),s._v(" "),n("p",[s._v("本文基于 docker 安装的达梦数据库作为示例操作，非 docker 环境只需掠过 docker 操作即可。")]),s._v(" "),n("h4",{attrs:{id:"开启归档"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#开启归档"}},[s._v("#")]),s._v(" 开启归档")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查询是否开启归档 Y表示已开启归档，N表示未开启归档")]),s._v("\nsql"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" name, status$, arch_mode from "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("v")]),n("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$database")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改数据库为 Mount 状态")]),s._v("\nsql"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ALTER DATABASE MOUNT"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置本地归档")]),s._v("\nsql"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ALTER DATABASE ADD ARCHIVELOG "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'DEST = /home/dm_arch, TYPE = local,FILE_SIZE = 1024, SPACE_LIMIT = 2048'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启归档模式")]),s._v("\nsql"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ALTER DATABASE ARCHIVELOG"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改数据库为 Open 状态")]),s._v("\nsql"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ALTER DATABASE OPEN"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启数据库或重启服务")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重启数据容器")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker restart dm8")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 或者重启服务（stop 和 start 需要一点时间，不是卡住了，请耐心等待）")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it dm8 /bin/bash")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/dmdbms/bin\n./DmService stop\n./DmService start\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br")])]),n("h3",{attrs:{id:"联机全备"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#联机全备"}},[s._v("#")]),s._v(" 联机全备")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 全量备份")]),s._v("\nsql"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" BACKUP DATABASE FULL BACKUPSET "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/home/dm_full_bak'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 复制备份文件到宿主机。复制到宿主机目录：/home/dm_full_bak")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker cp dm8:/home/dm_full_bak /home/")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 移动宿主机上备份文件夹 /home/dm_full_bak 目录到要还原的达梦主机上")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里就备份完成了。然后 U 盘复制备份文件到目标主机的 /home/dm_full_bak")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 登录目标主机")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 把备份文件，移动到目标主机中 docker 容器的 /home/dm_full_bak 目录")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker cp /home/dm_full_bak dm8:/home/")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Windows 下复制：cd /d D: && docker cp dm_full_bak dm8:/home/")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it dm8 /bin/bash")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 容器中查看")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" -l /home/dm_full_bak\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 递归修改该文件夹及子文件/文件夹的拥有者及用户组。以便后面还原时 dmdba 用户有权限读取")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 否则后面还原数据库时，会出现这个问题 [-8024]:Fail to read write data file")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /home\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" -R dmdba:dinstall dm_full_bak\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 退出，后面切换 dmdba 用户进入容器")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br")])]),n("h3",{attrs:{id:"脱机还原-dmrman"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#脱机还原-dmrman"}},[s._v("#")]),s._v(" 脱机还原（dmrman）")]),s._v(" "),n("div",{staticClass:"language-shell line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 切换 dmdba 用户进入容器")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker exec -it --user dmdba dm8 /bin/bash")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查 dm.ini 父级目录，即数据库的实例名")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" -l /opt/dmdbms/data\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 其中，DAMENG 就是数据库的实例名")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" -l /opt/dmdbms/data/DAMENG\n\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 停止达梦服务")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt/dmdbms/bin\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 否则会出现这个问题：[-137]:DM server is running or exist other process which is operating the same database")]),s._v("\n./DmService stop\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一般都有 DAMENG 库实例了，所以不需要这一步。")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#准备目标库。还原目标库可以是已经存在的数据库，也可使用 dminit 工具初始化一个新库。如下所示： ")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./dminit path=/opt/dmdbms/data db_name=DAMENG ")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 方便复制：/opt/dmdbms/bin/dmrman")]),s._v("\n./dmrman\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 校验备份，校验待还原备份集的合法性。校验备份有两种方式，联机和脱机，此处使用脱机校验； ")]),s._v("\nRMAN"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" CHECK BACKUPSET "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/home/dm_full_bak'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以下命令中：需要现在达梦的安装目录找到 dm.ini 文件的位置。并且路径中的【DAMENG】为数据库实例（名字根据安装时写的），如果有多个，则需要选择需要还原的数据库实例。")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果出现这个问题 [-8024]:Fail to read write data file。则是前面没有执行 chown -R dmdba:dinstall dm_bak，导致 dmdba 用户没有权限读取备份文件。")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 还原数据库（恢复数据文件）。启动 DMRMAN，输入以下命令： ")]),s._v("\nRMAN"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" RESTORE DATABASE "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/opt/dmdbms/data/DAMENG/dm.ini'")]),s._v(" FROM BACKUPSET "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/home/dm_full_bak'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行还原数据库的命令之后，可以直接执行恢复数据库的命令（进行数据库一致性修复），如下：")]),s._v("\nRMAN"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" RECOVER DATABASE "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/opt/dmdbms/data/DAMENG/dm.ini'")]),s._v(" FROM  BACKUPSET "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/home/dm_full_bak'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 数据库更新")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指更新数据库的 DB_MAGIC，并将数据库调整为可正常工作状态，与数据库恢复一样使用 RECOVER 命令完成。数据库更新发生在重做 REDO 日志恢复数据库后。")]),s._v("\nRMAN"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" RECOVER DATABASE "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/opt/dmdbms/data/DAMENG/dm.ini'")]),s._v(" UPDATE DB_MAGIC"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 退出 dmrman")]),s._v("\nRMAN"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exit")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动停止的达梦服务")]),s._v("\n./DmService start\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 还原完成")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);