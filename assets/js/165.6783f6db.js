(window.webpackJsonp=window.webpackJsonp||[]).push([[165],{591:function(s,t,a){"use strict";a.r(t);var n=a(28),r=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h3",{attrs:{id:"背景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#背景"}},[s._v("#")]),s._v(" 背景")]),s._v(" "),a("p",[s._v("今天突然收到百度云发来的告警邮件，说我的服务器出现了异常挖矿行为，意味着我的服务器被黑了。导致我部署的服务响应慢，甚至无法访问。于是晚上就开始了排查工作。")]),s._v(" "),a("h3",{attrs:{id:"last-命令查看登录记录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#last-命令查看登录记录"}},[s._v("#")]),s._v(" last 命令查看登录记录")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# last")]),s._v("\nroot     pts/0        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("112.111")]),s._v(".24.78    Fri Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":14   still logged "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("\nroot     pts/0        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("106.44")]),s._v(".60.63     Fri Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":00 - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(":02  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("00:02"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot     pts/0        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("113.200")]),s._v(".202.122  Fri Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":16 - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(":17  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("00:01"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot     pts/0        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("117.35")]),s._v(".117.234   Fri Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":47 - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":51  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("00:04"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot     pts/0        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("117.35")]),s._v(".117.234   Fri Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":31 - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":41  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("00:09"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot     pts/0        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("117.35")]),s._v(".117.234   Fri Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":19 - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":25  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("00:06"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("reboot")]),s._v("   system boot  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.10")]),s._v(".0-1160.41.1 Fri Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":29 - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":15  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("04:45"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot     pts/0        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("112.111")]),s._v(".24.94    Mon Feb "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":25 - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":28  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("00:02"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot     pts/1        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("112.111")]),s._v(".24.94    Mon Feb "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":17 - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":29  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("00:12"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot     pts/0        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("112.111")]),s._v(".24.94    Mon Feb "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":22 - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":34  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("02:12"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nwtmp begins Sat Feb "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":42:17 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("经过 IP 查询，未发现异常，但是系统中间却重启了一次，此时推断应该是：攻击者清除了登录记录日志导致的。")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("last 命令")]),s._v(" "),a("p",[s._v("last  列出当前和曾经登入系统的用户信息")]),s._v(" "),a("p",[s._v("它默认读取的是/var/log/wtmp文件的信息。")]),s._v(" "),a("p",[s._v("输出的内容包括：用户名、终端位置、登录源信息、开始时间、结束时间、持续时间。")]),s._v(" "),a("p",[s._v("注意最后一行输出的是wtmp文件起始记录的时间。")]),s._v(" "),a("p",[s._v("当然也可以通过 last -f 参数指定读取文件，可以是/var/log/btmp、/var/run/utmp")])]),s._v(" "),a("h3",{attrs:{id:"last-f-btmp-查看记录错误的登录尝试日志"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#last-f-btmp-查看记录错误的登录尝试日志"}},[s._v("#")]),s._v(" last -f btmp 查看记录错误的登录尝试日志")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("btmp 文件")]),s._v(" "),a("p",[s._v("/var/log/btmp 用于记录错误的登录尝试")]),s._v(" "),a("p",[s._v("/var/log/btmp 文件过大形成原因：可能存在暴力破解登录所致")]),s._v(" "),a("p",[s._v("文件过大的解决方法：")]),s._v(" "),a("ul",[a("li",[s._v("初步清理该文件 echo > /var/log/btmp")]),s._v(" "),a("li",[s._v("更换远程登录端口")]),s._v(" "),a("li",[s._v("lastb 查看具体信息，查找出现次数较多的，封IP")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查找恶意登录的前十个IP")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" lastb "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{ print $3}'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{++S[$NF]} END {for(a in S) print a, S[a]}'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sort")]),s._v(" -rk2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("head")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看Linux 文件系统磁盘的使用情况")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("df")]),s._v(" -h\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# last -f btmp")]),s._v("\nroot     ssh:notty    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("43.154")]),s._v(".163.60    Fri Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":19    gone - no "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("logout")]),s._v("\nroot     ssh:notty    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("148.66")]),s._v(".135.237   Fri Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":15 - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":19  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("00:04"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nfoo      ssh:notty    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("43.154")]),s._v(".163.60    Fri Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":15 - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":15  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("00:00"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(" 此处省略中间其他记录\nroot     ssh:notty    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("143.110")]),s._v(".182.208  Tue Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" 04:00 - 05:20  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("01:19"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot     ssh:notty    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("143.110")]),s._v(".182.208  Tue Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" 04:00 - 04:00  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("00:00"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot     ssh:notty    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("143.110")]),s._v(".182.208  Tue Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" 03:59 - 04:00  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("00:00"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nroot     ssh:notty    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("143.110")]),s._v(".182.208  Tue Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" 03:58 - 03:59  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("00:00"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nbtmp begins Tue Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" 03:58:56 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("可以发现，从最早的记录四天前就已经开始产生了很多错误登录日志。此时推断：大概率为被用字典暴力破解了密码。")]),s._v(" "),a("p",[s._v("查看 btmp 文件大小为：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls -alh")]),s._v("\ntotal 44M\n-rw-------   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root   utmp            502K Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":49 btmp\n-rw-rw-r--   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root   utmp             11K Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":50 wtmp\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("可以发现，wtmp 文件记录的登录日志只有 11k，而登录错误日志记录却有 502k 大。基本可以实锤是被暴力破解了。")]),s._v(" "),a("p",[s._v("由于使用 last -f btmp 命令列出来的登录错误数记录太多了，因此这里找出恶意登录的前十个 IP，并查询其归属地如下：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# lastb | awk '{ print $3}' | awk '{++S[$NF]} END {for(a in S) print a, S[a]}' | sort -rk2 |head")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("45.61")]),s._v(".185.188 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("        美国 加利福尼亚 洛杉矶\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("143.198")]),s._v(".227.202 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("      美国 科罗拉多\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("121.5")]),s._v(".205.212 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("        中国 上海市 上海市\t腾讯云 数据中心\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("116.247")]),s._v(".81.99 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("        印度尼西亚 雅加达\t阿里云 数据中心\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("116.235")]),s._v(".92.247 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("       中国 上海市 宝山区\t电信\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.215")]),s._v(".29.53 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("          印度尼西亚 雅加达\t阿里云 数据中心\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("60.10")]),s._v(".199.104 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("        中国 河北省 廊坊市 三河市\t联通\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("49.234")]),s._v(".45.241 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("        中国 上海市 上海市\t腾讯云 数据中心\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("46.19")]),s._v(".139.42 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("         瑞士 苏黎世\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("43.154")]),s._v(".56.24 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("         中国 香港特别行政区\t腾讯云 数据中心\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h3",{attrs:{id:"再查看一下-root-用户执行的命令的历史记录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#再查看一下-root-用户执行的命令的历史记录"}},[s._v("#")]),s._v(" 再查看一下 root 用户执行的命令的历史记录")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# history 500")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/02/26 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":41:48 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /root/.bash_history\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("  root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/02/26 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":41:48 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /var/log/wtmp\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("  root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/02/26 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":41:48 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /var/log/btmp\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("  root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/02/26 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":41:48 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /var/spool/mail/root\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("  root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/02/26 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":41:48 chattr +i /var/spool/mail/root\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("  root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/02/26 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":41:48 chattr -i /var/log/wtmp /var/log/btmp\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("  root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/03/04 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":50:30 "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /var/log\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("  root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/03/04 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":50:34 ll\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("  root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/03/04 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":52:54 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" -alh\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("  root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("/03/04 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":03:51 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("history")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("发现，果然，第 2~4 行清空了登录日志记录等信息。跟前面用 last 命令看到的结果对应。毫无疑问， history 也让攻击者清理了。大致推断 2022/02/26 服务器已经被攻破了。")]),s._v(" "),a("p",[s._v("第 5 行用 chattr 命令又锁定了 /var/spool/mail/root 文件。")]),s._v(" "),a("p",[s._v("第 6 行用 chattr 命令取消锁定 /var/log/wtmp /var/log/btmp 文件。")]),s._v(" "),a("h3",{attrs:{id:"top-命令查看一下-cpu-占用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#top-命令查看一下-cpu-占用"}},[s._v("#")]),s._v(" top 命令查看一下 CPU 占用")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# top")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":17:52 up  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(":47,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" users,  load average: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.85")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.89")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.96")]),s._v("\nTasks: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("158")]),s._v(" total,   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" running, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("157")]),s._v(" sleeping,   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" stopped,   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" zombie\n%Cpu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("99.8")]),s._v(" us,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.2")]),s._v(" sy,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" ni,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" id,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" wa,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" hi,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" si,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" st\nKiB Mem "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4045012")]),s._v(" total,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2788908")]),s._v(" free,   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("348176")]),s._v(" used,   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("907928")]),s._v(" buff/cache\nKiB Swap:        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" total,        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" free,        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" used.  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3468732")]),s._v(" avail Mem\n\n  PID "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("USER")]),s._v("      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17225")]),s._v(" root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("89140")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7792")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" S "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("199.7")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("438")]),s._v(":59.29 bioser\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 进程 1428 后面再说")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1428")]),s._v(" root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("88692")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("916")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("404")]),s._v(" S "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("148.8")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("195")]),s._v(":14.57 kworker\n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1700")]),s._v(" polkitd   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("52812")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9964")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3128")]),s._v(" S   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.3")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.2")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":31.44 redis-server\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("可以发现 CPU 占用极高，长时间 99.8% us 了，其中 PID 17225 这个进程 CPU 占用率极大。")]),s._v(" "),a("h3",{attrs:{id:"用命令-netstat-antlp-查看了应用连接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#用命令-netstat-antlp-查看了应用连接"}},[s._v("#")]),s._v(" 用命令 netstat -antlp 查看了应用连接")]),s._v(" "),a("p",[s._v("找到 PID=17255 进程的应用连接如下：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# netstat -antlp")]),s._v("\nActive Internet connections "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("servers and established"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name\ntcp        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.4:37572       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("104.244")]),s._v(".46.165:443      SYN_SENT    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17225")]),s._v("/bioser\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("经过查询 IP 得知，IP 104.244.46.165 地址为 美国 加利福尼亚 （网络 Twitter）。我有点懵逼了，twitter 跟挖矿有关系？")]),s._v(" "),a("h3",{attrs:{id:"查看这个程序的根源出自哪里-使用命令-ls-l-proc-进程号-exe-探查"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看这个程序的根源出自哪里-使用命令-ls-l-proc-进程号-exe-探查"}},[s._v("#")]),s._v(" 查看这个程序的根源出自哪里，使用命令 ls -l /proc/进程号/exe 探查")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls -l /proc/17225/exe")]),s._v("\nlrwxrwxrwx "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":40 /proc/17225/exe -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /usr/bin/bioser\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("发现它指向 /usr/bin/bioser 文件。通过 ll 命令查看文件创建日期，也是 2022-02-26 日 16:41，时间对的上，所以这个程序文件肯定是有问题的。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("-rwxr-xr-x  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2427132")]),s._v(" Feb "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":41 bioser\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"检查出现问题用户的-crontab-定时任务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#检查出现问题用户的-crontab-定时任务"}},[s._v("#")]),s._v(" 检查出现问题用户的 crontab 定时任务")]),s._v(" "),a("p",[s._v("检查出现问题用户的 crontab 定时任务，看是否被写入了定时计划，否则可能定时或者reboot之后又会启动病毒，使用命令 crontab -l -u root 检查。或者直接 crontab -l")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls tmp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# crontab -l")]),s._v("\n*/5 * * * * /opt/hosteye/bin/upgrade --upgrade_mode"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("8")]),s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("并没有发现有异常的定时计划。如果有的话就需要删除异常定时计划。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看帮助")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("crontab")]),s._v(" -h\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 清除所有用户定时任务")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("crontab")]),s._v(" -r \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("另外，还需排查以下目录的定时任务：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls etc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /etc")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls etc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll")]),s._v("\ndrwxr-xr-x.  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" Jun "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":38 cron.d\ndrwxr-xr-x.  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" Jan "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" cron.daily\n-rw-------.  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" Aug  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v(" cron.deny\ndrwxr-xr-x.  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" Jun "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(":38 cron.hourly\ndrwxr-xr-x.  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" Jun "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2014")]),s._v(" cron.monthly\n-rw-r--r--.  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("451")]),s._v(" Jun "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2014")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("crontab")]),s._v("\ndrwxr-xr-x.  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" root root     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" Jun "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2014")]),s._v(" cron.weekly\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看以上文件是否有指向异常进程相同的 url 或者未知的定时任务。")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h3",{attrs:{id:"检查-root-用户-ssh-目录下-authorized-keys-是否被配置了后门的-ssh-的-key"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#检查-root-用户-ssh-目录下-authorized-keys-是否被配置了后门的-ssh-的-key"}},[s._v("#")]),s._v(" 检查 root 用户 .ssh 目录下 authorized_keys 是否被配置了后门的 ssh 的 key")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls tmp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd ~")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll")]),s._v("\ntotal "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\ndrwxr-xr-x "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" Jan "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(":27 upload\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("并未发现 root 用户目录下有 .ssh 目录，因此这里没有问题。如果有就删掉对应的 key。")]),s._v(" "),a("h2",{attrs:{id:"病毒清理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#病毒清理"}},[s._v("#")]),s._v(" 病毒清理")]),s._v(" "),a("p",[s._v("通过以上排查，认为只需要杀掉 bioser(进程号：17225) 进程，然后清理掉 /usr/bin/bioser 文件即可。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kill -9 17225")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 当我以为万事大吉的时候，却出现了下面的问题。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls bin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rm -rf bioser")]),s._v("\nrm: cannot remove ‘bioser’: Operation not permitted\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("我用 root 用户，居然删不掉它！！！")]),s._v(" "),a("p",[s._v("查看用户组，感觉没啥特别的：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls bin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll")]),s._v("\n-rwxr-xr-x  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2427132")]),s._v(" Feb "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":41 bioser\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("此时想到前面攻击者用 chattr 命令锁定和取消锁定了一些文件，我也尝试一下解锁 bioser 文件：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看文件属性：")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls bin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# lsattr bioser")]),s._v("\n-----a-------e-- bioser\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 去除属性")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls bin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chattr -a /usr/bin/bioser")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls bin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rm -rf bioser")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除成功了")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls bin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("lsattr 查看文件属性")]),s._v(" "),a("p",[s._v("看到的情况如果是 -----a-------或者-----i------- 就要去除属性才能删除。---e--表示 ext4 或 ext3 文件系统所特有的")]),s._v(" "),a("p",[s._v("去除属性：chattr -a xxx 或者 chattr -i xxx")])]),s._v(" "),a("p",[s._v("当我以为再次万事大吉的时候，用 top 命令看了下，发现 bioser 的进程又活过来了！！！这次变成了 PID 17816")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 再次查看进程指向，此时显示文件已被删除，应该是我删除操作慢了，还有恢复进程把它在我还没删除的时候又拉起来了。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls bin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls -l /proc/17816/exe")]),s._v("\nlrwxrwxrwx "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":00 /proc/17816/exe -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /usr/bin/bioser "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("deleted"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 于是，我尝试再次删除它")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls bin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kill -9 17816")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("于是新的问题来了，是哪个进程把它重新拉起来的呢？(实际上是它自己把自己拉起来了，我中了两个病毒。) 再次用 top 命令查看 CPU 占用，发现进程号为 1428 的 CPU 占用率高。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls bin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# top")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":24:59 up  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(":55,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" users,  load average: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.56")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.48")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.62")]),s._v("\nTasks: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("163")]),s._v(" total,   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" running, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("161")]),s._v(" sleeping,   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" stopped,   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" zombie\n%Cpu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(":  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8.2")]),s._v(" us, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("64.0")]),s._v(" sy,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" ni, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19.7")]),s._v(" id,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" wa,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" hi,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7.9")]),s._v(" si,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.2")]),s._v(" st\nKiB Mem "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4045012")]),s._v(" total,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1266032")]),s._v(" free,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1646100")]),s._v(" used,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1132880")]),s._v(" buff/cache\nKiB Swap:        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" total,        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" free,        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" used.  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2169340")]),s._v(" avail Mem\n\n  PID "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("USER")]),s._v("      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND\n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1428")]),s._v(" root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("88692")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("916")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("404")]),s._v(" S "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("151.5")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("199")]),s._v(":23.66 kworker\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(" root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" S   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.3")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(":46.79 ksoftirqd/0\n   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" S   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.3")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(":41.50 ksoftirqd/1\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20575")]),s._v(" root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1419924")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("39056")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13664")]),s._v(" S   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.3")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":31.09 hosteye\n    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(" root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" R   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.7")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":52.47 rcu_sched\n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5614")]),s._v(" root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3711416")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("720748")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13836")]),s._v(" S   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17.8")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(":03.27 java\n "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7178")]),s._v(" root      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3529616")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("540816")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13648")]),s._v(" S   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13.4")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":36.47 java\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("查看 1428 进程指向：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls bin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls -l /proc/1428/exe")]),s._v("\nlrwxrwxrwx "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(":30 /proc/1428/exe -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/kworker\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls bin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls bin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /etc")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls etc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll")]),s._v("\ntotal "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2652")]),s._v("\n-rwsrwsrwt   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1223123")]),s._v(" Feb "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":41 kworker\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("查看 kworker 文件创建日期，和前面删除的 bioser 文件一样，也是 2022-02-26 日 16:41 创建的，时间对的上。那么这个文件也是有问题的。")]),s._v(" "),a("p",[s._v("貌似有个系统进程就要 kworker，这个新创建的文件也叫 kworker，不管了，直接杀进程，删文件。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls etc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kill -9 1428")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls etc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看文件属性，猜测应该跟删除 bioser 文件一样，被锁定了，要先解锁才能删除。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls etc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# lsattr kworker")]),s._v("\n----ia-------e-- kworker\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls etc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 果然被锁定了，而且同时加了 i 和 a 属性。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 去除属性。-ai：同时去除 i 和 a 属性")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls etc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# chattr -ai /etc/kworker")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls etc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rm -rf kworker")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("到这里我感觉就已经万事大吉了。top 命令查看一下。发现 kworker 又活了，PID 变成了 18860")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 再次查看进程指向，此时显示文件已被删除，好吧，又是我手慢了，在我删除之前它已经拉起来了。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls etc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ls -l /proc/18860/exe")]),s._v("\nlrwxrwxrwx "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" root root "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" Mar  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":31 /proc/18860/exe -"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/kworker "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("deleted"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls etc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 于是，我尝试再次删除它")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls bin"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kill -9 18860")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("这下应该好了吧！top 命令查看，一切正常，重启一下看看，重启也没问题。等第二天再看看。夜深了，暂时可以洗洗睡啦。")]),s._v(" "),a("p",[s._v("正当我准备以为暂时没问题了，可以关电脑的时候，发现 /etc/kworker 文件自己又回来了！！！")]),s._v(" "),a("p",[s._v("通过查找资料，/etc/kworker 应该是一个系统程序，那为什么 CPU 占用率高呢？我认为应该是攻击者修改了 kworker 的代码，加入了恶意代码，然后覆盖掉操作系统原有的程序。")]),s._v(" "),a("p",[s._v("通过查看定时任务发现：百度云默认安装了 /opt/hosteye/bin/hosteye 软件，这个应该是百度云安全监控的。它可能会检测自动升级。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ls etc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# crontab -l")]),s._v("\n*/5 * * * * /opt/hosteye/bin/upgrade --upgrade_mode"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("8")]),s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("当我删掉 kworker 时，自然清理掉了恶意程序。")]),s._v(" "),a("p",[s._v("此时猜测，操作系统运行应该还是需要 kworker 程序的，它可能有什么自我修复的功能，又把安全的 kwoker 恢复了。")]),s._v(" "),a("p",[s._v("具体原因不明（有高手知道的话求分享）。反正第二天查看 CPU 占用，一切正常了。")]),s._v(" "),a("h4",{attrs:{id:"思考和总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#思考和总结"}},[s._v("#")]),s._v(" 思考和总结")]),s._v(" "),a("p",[s._v("感觉我应该中了两个病毒程序，一个是 bioser，有自我唤醒的特点；一个是被恶意修改了的 kworker。")]),s._v(" "),a("p",[s._v("只要这两个恶意文件存在，它们就能够被拉起来，不清楚还有没有其他某个地方被攻击者修改了，先观察一段时间。")]),s._v(" "),a("h3",{attrs:{id:"后记"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#后记"}},[s._v("#")]),s._v(" 后记")]),s._v(" "),a("p",[s._v("我以为我这个服务器就是自己测试用的，应该没有黑客大佬惦记，因此服务器 root 用户的密码设置的很简单，防火墙也没开，所有的应用端口也都是默认的，结果还真中奖了。")]),s._v(" "),a("p",[s._v("接下来，是要考虑增加一些安全措施了。大概列一下：")]),s._v(" "),a("ul",[a("li",[s._v("密码要设置的复杂一些，增加被暴力破解的难度；")]),s._v(" "),a("li",[s._v("时刻将防火墙开启，仅开放需要的端口号；")]),s._v(" "),a("li",[s._v("更改默认远程 SSH 端口。可以参考"),a("a",{attrs:{href:"https://cloud.baidu.com/doc/BCC/s/mkne08a7p",target:"_blank",rel:"noopener noreferrer"}},[s._v("百度云服务器安全说明"),a("OutboundLink")],1),s._v("；")]),s._v(" "),a("li",[s._v("即使清除了挖矿程序，也不能确保攻击者还留有其他后门，最好备份数据后，重装系统。")])])])}),[],!1,null,null,null);t.default=r.exports}}]);